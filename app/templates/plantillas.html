{% extends "base.html" %}

{% block content %}

<style>
    .planning-layout {
        display: flex;
        gap: 2rem;
        align-items: flex-start;
    }

    .planning-main {
        flex: 3;
        min-width: 0;
        /* Prevent flex blowout */
    }

    .planning-sidebar {
        flex: 2;
        min-width: 300px;
        position: sticky;
        top: 2rem;
        max-height: calc(100vh - 4rem);
        overflow-y: auto;
        background: #F9FAFB;
        border: 1px solid #E5E7EB;
        border-radius: 8px;
        padding: 1.5rem;
    }

    /* Mobile Responsive */
    @media (max-width: 900px) {
        .planning-layout {
            flex-direction: column-reverse;
            /* Form bottom, Context top? User needs context. */
            flex-direction: column;
        }

        .planning-sidebar {
            position: static;
            /* No sticky on mobile */
            width: 100%;
            max-height: none;
            margin-bottom: 2rem;
            order: -1;
            /* Show context first on mobile */
        }
    }

    .ctx-section {
        margin-bottom: 1.5rem;
    }

    .ctx-label {
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: #6B7280;
        margin-bottom: 0.5rem;
        font-weight: 600;
    }

    .ctx-content {
        padding: 0.75rem;
        border-radius: 6px;
        font-size: 0.9rem;
        line-height: 1.5;
        white-space: pre-wrap;
    }

    /* Colores Contexto */
    .ctx-energy {
        background: #FEF3C7;
        border-left: 3px solid #F59E0B;
        color: #78350F;
    }

    .ctx-focos {
        background: #FEF2F2;
        border-left: 3px solid #EF4444;
        color: #7F1D1D;
    }

    .ctx-mante {
        background: #ECFDF5;
        border-left: 3px solid #10B981;
        color: #064E3B;
    }

    .ctx-semilla {
        background: #EFF6FF;
        border-left: 3px solid #3B82F6;
        color: #1E40AF;
    }
</style>

<div class="planning-layout">

    <!-- COLUMNA IZQUIERDA: FORMULARIO PLAN DIARIO -->
    <div class="planning-main">
        <div style="margin-bottom: 2rem;">
            <h1>‚ö° Plan Diario</h1>
            <p style="font-style: italic; color: #4B5563; margin-bottom: 0.5rem;">
                Principio: Sostener el d√≠a con dignidad. <strong>Tres bloques.</strong> No llenar por llenar.
            </p>
        </div>

        <!-- Panel Realidad vs Intenci√≥n (Historial de Puntos) - Restored -->
        {% if state is defined and state.historial_puntos %}
        <div
            style="background: #ffffff; border: 1px solid #e5e7eb; border-radius: 8px; padding: 1rem; margin-bottom: 1.5rem; display: flex; align-items: center; justify-content: space-between;">
            <div style="font-size: 0.85rem; color: #4b5563; font-weight: 600;">
                üîç Realidad de los √∫ltimos d√≠as
            </div>
            <div style="display: flex; gap: 1.5rem;">
                {% for dia in state.historial_puntos %}
                <div style="display: flex; flex-direction: column; align-items: center; gap: 0.25rem;">
                    <span style="font-size: 0.7rem; color: #9ca3af; text-transform: uppercase;">{{ dia.fecha[-5:]
                        }}</span>
                    <div style="display: flex; gap: 2px;">
                        {% for punto in dia.puntos %}
                        <div style="width: 8px; height: 8px; border-radius: 50%; background-color: {% if punto == 'red' %}#ef4444{% elif punto == 'green' %}#10b981{% elif punto == 'blue' %}#3b82f6{% else %}#d1d5db{% endif %};"
                            title="{{ punto }}"></div>
                        {% endfor %}
                        {% if not dia.puntos %}
                        <span style="font-size: 0.7rem; color: #d1d5db;">(Sin datos)</span>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <div class="form-section form-container-daily">
            <form action="/api/guardar" method="POST" id="daily-form">
                <input type="hidden" name="tipo" value="Plan Diario">

                <!-- SECCION 1: OBLIGACIONES -->
                <div class="form-group">
                    <label>1. Obligaciones Reales (Ya existen)</label>
                    <div
                        style="background: #eef2ff; border-left: 3px solid #6366f1; padding: 0.75rem; margin-bottom: 1rem; font-size: 0.85rem; color: #4338ca;">
                        <strong>Micro-decisi√≥n:</strong> Etiqueta cada tarea. <br>
                        <span style="color: #ef4444;">üî¥ Foco (Trabajo)</span> |
                        <span style="color: #10b981;">üü¢ Mante (Sost√©n)</span> |
                        <span style="color: #3b82f6;">üîµ Semilla (Futuro)</span>
                    </div>

                    <div id="obligaciones-container"
                        style="display: flex; flex-direction: column; gap: 0.5rem; margin-bottom: 1rem;">
                        <!-- Rows will be added dynamically -->
                    </div>

                    <button type="button" class="btn btn-outline" onclick="addObligationRow()"
                        style="font-size: 0.85rem; padding: 0.5rem 1rem;">
                        + A√±adir obligaci√≥n
                    </button>
                    <input type="hidden" name="obligaciones" id="b1">
                </div>

                <!-- SECCION 2: ESTRUCTURAL -->
                <div class="form-group"
                    style="background: #F3F4F6; padding: 1.5rem; border-radius: 4px; border: 2px dashed #9CA3AF;">
                    <label style="color: #EF4444;">2. Tarea Estructural (M√°ximo 1 ‚Äî SOLO UNA)</label>
                    <small style="display: block; color: #666; margin-bottom: 0.5rem; font-style: italic;">
                        Elige una sola cosa del inventario (derecha) que mover√° la aguja hoy.
                    </small>
                    <div style="display: flex; gap: 0.5rem;">
                        <input type="text" name="tarea_ancla" id="b2" placeholder="Ej: Avanzar reporte Q1..."
                            style="padding: 1.2rem; flex: 3;">

                        <!-- Horizonte Esperado -->
                        <select name="horizonte_tarea_ancla" id="b2-horizonte"
                            style="flex: 1; padding: 0.5rem; font-size: 0.85rem; border: 1px solid #d1d5db; border-radius: 4px; color: #4b5563;">
                            <option value="">(Horizonte)</option>
                            <option value="1-2 d√≠as">1-2 d√≠as</option>
                            <option value="3-5 d√≠as">3-5 d√≠as</option>
                            <option value="1 semana">1 semana</option>
                            <option value="2 semanas">2 semanas</option>
                            <option value="+1 mes">+1 mes</option>
                        </select>
                    </div>
                </div>

                <!-- SECCION 3: REACTIVO -->
                <div class="form-group">
                    <label>3. Espacio Reactivo / Libre</label>
                    <textarea name="resto_dia" id="b3" style="min-height: 100px;"
                        placeholder="Responder mensajes, imprevistos, descanso..."></textarea>
                </div>

                <input type="hidden" name="contenido" id="daily-full-content">

                <div id="daily-preview-container" class="hidden">
                    <label>Confirmar Plan</label>
                    <div id="daily-preview" class="preview-box"></div>
                </div>

                <div style="display: flex; gap: 1rem; align-items: center; margin-top: 2rem;">
                    <button type="button" class="btn btn-outline" onclick="composeDaily()">Ver Vista Previa</button>
                    <button type="submit" class="btn" onclick="composeDaily()">Comprometer Plan</button>
                </div>
            </form>
        </div>
    </div>

    <!-- COLUMNA DERECHA: CONTEXTO (INVENTARIO) -->
    <aside class="planning-sidebar" id="planning-sidebar" style="transition: width 0.3s ease;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
            <h3 style="margin: 0; font-size: 1.1rem; color: #111;">üìã √öltimo Inventario</h3>
            <div style="display: flex; gap: 1rem; align-items: center;">
                {% if inventario %}
                <span style="font-size: 0.75rem; color: #6B7280;">{{ inventario.timestamp or 'Reciente' }}</span>
                {% endif %}
                <button type="button" onclick="toggleSidebar()"
                    style="background: none; border: none; cursor: pointer; color: #6B7280; font-size: 0.9rem; padding: 0.2rem;"
                    title="Ocultar Contexto">
                    ‚úñÔ∏è
                </button>
            </div>
        </div>

        {% if inventario %}
        <!-- Energ√≠a -->
        {% if inventario.energia %}
        <div class="ctx-section">
            <div class="ctx-label">‚ö° Energ√≠a / Estado</div>
            <div class="ctx-content ctx-energy">{{ inventario.energia }}</div>
        </div>
        {% endif %}

        <!-- Focos Activos (New + Legacy Fallback) -->
        {% if inventario.focos_activos or inventario.claridad_frentes %}
        <div class="ctx-section">
            <div class="ctx-label" style="color: #B91C1C;">üî¥ Focos Activos (Q1)</div>
            <div class="ctx-content ctx-focos">{{ inventario.focos_activos or inventario.claridad_frentes }}</div>
        </div>
        {% endif %}

        <!-- Mantenimiento -->
        {% if inventario.mantenimiento %}
        <div class="ctx-section">
            <div class="ctx-label" style="color: #047857;">üü¢ Mantenimiento (Sost√©n)</div>
            <div class="ctx-content ctx-mante">{{ inventario.mantenimiento }}</div>
        </div>
        {% endif %}

        <!-- Semillas (New + Legacy Fallback) -->
        {% if inventario.semillas or inventario.ajuste_necesario %}
        <div class="ctx-section">
            <div class="ctx-label" style="color: #1D4ED8;">üîµ Semillas / Futuro</div>
            <div class="ctx-content ctx-semilla">{{ inventario.semillas or inventario.ajuste_necesario }}</div>
        </div>
        {% endif %}

        <div style="margin-top: 2rem; border-top: 1px solid #E5E7EB; padding-top: 1rem; text-align: center;">
            <a href="/editar-inventario" style="font-size: 0.8rem; color: #6B7280; text-decoration: underline;">‚úèÔ∏è
                Corregir Inventario</a>
        </div>

        {% else %}
        <div style="text-align: center; padding: 2rem 1rem; color: #6B7280; font-style: italic;">
            <p>No hay inventario registrado.</p>
            <a href="/nuevo-inventario" class="btn btn-sm">Crear Inventario</a>
        </div>
        {% endif %}
    </aside>

    <!-- Bot√≥n para MOSTRAR contexto cuando est√° oculto -->
    <div id="show-context-helper"
        style="display: none; position: fixed; right: 0; top: 50%; transform: translateY(-50%); z-index: 50;">
        <button onclick="toggleSidebar()"
            style="background: #3B82F6; color: white; border: none; padding: 1rem 0.5rem; border-radius: 8px 0 0 8px; cursor: pointer; writing-mode: vertical-rl; text-orientation: mixed; font-weight: 600; box-shadow: -2px 0 5px rgba(0,0,0,0.1);">
            üìã Ver Contexto
        </button>
    </div>

</div>

<script>
    // Initialize with one empty row
    docReady(function () {
        if (document.getElementById('obligaciones-container')) {
            addObligationRow();
        }
    });

    function generateUUID() {
        return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
            var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
            return v.toString(16);
        });
    }

    function addObligationRow(text = '', type = 'foco') {
        const container = document.getElementById('obligaciones-container');
        const id = generateUUID();

        const row = document.createElement('div');
        row.className = 'obligation-row';
        row.dataset.id = id;
        row.style.display = 'flex';
        row.style.gap = '0.5rem';
        row.style.alignItems = 'center';
        row.style.padding = '0.5rem';
        row.style.background = 'white';
        row.style.border = '1px solid #e5e7eb';
        row.style.borderRadius = '6px';

        // Check registable vs nota? Mantenemos simple con selector de tag
        // Nuevo dise√±o: Input texto + Radio buttons de colores

        row.innerHTML = `
            <div style="flex: 1;">
                <input type="text" class="form-control obl-text" value="${text}" placeholder="Descripci√≥n..." 
                    style="width: 100%; border: none; outline: none; font-size: 0.95rem;">
            </div>
            
            <div style="display: flex; gap: 0.25rem; background: #f3f4f6; padding: 0.25rem; border-radius: 4px;">
                <label style="cursor: pointer; display: flex; align-items: center; padding: 0 0.25rem;" title="Foco (Trabajo)">
                    <input type="radio" name="tag_${id}" value="foco" checked class="obl-tag">
                    <span style="font-size: 0.8rem;">üî¥</span>
                </label>
                <label style="cursor: pointer; display: flex; align-items: center; padding: 0 0.25rem;" title="Mantenimiento">
                    <input type="radio" name="tag_${id}" value="mantenimiento" class="obl-tag">
                    <span style="font-size: 0.8rem;">üü¢</span>
                </label>
                <label style="cursor: pointer; display: flex; align-items: center; padding: 0 0.25rem;" title="Semilla (Futuro)">
                    <input type="radio" name="tag_${id}" value="semilla" class="obl-tag">
                    <span style="font-size: 0.8rem;">üîµ</span>
                </label>
            </div>

            <button type="button" class="btn btn-outline" onclick="removeObligationRow(this)" style="padding: 0.2rem 0.5rem; color: #9ca3af; border: none;" title="Eliminar">
                ‚úï
            </button>
        `;

        container.appendChild(row);

        // Focus new input if it's empty
        if (!text) {
            row.querySelector('input').focus();
        }
    }

    function removeObligationRow(btn) {
        btn.parentElement.remove();
    }

    function docReady(fn) {
        if (document.readyState === "complete" || document.readyState === "interactive") {
            setTimeout(fn, 1);
        } else {
            document.addEventListener("DOMContentLoaded", fn);
        }
    }

    function composeDaily() {
        // Collect Obligations
        const rows = document.querySelectorAll('.obligation-row');
        const obligationsList = [];
        let obligationsMarkdown = '';

        rows.forEach(row => {
            const text = row.querySelector('.obl-text').value.trim();
            // Get selected radio
            const selectedRadio = row.querySelector('input[type="radio"]:checked');
            const tag = selectedRadio ? selectedRadio.value : 'foco';

            const id = row.dataset.id;

            // Map tag to emoji for markdown
            const emojis = { 'foco': 'üî¥', 'mantenimiento': 'üü¢', 'semilla': 'üîµ' };
            const emoji = emojis[tag] || 'üî¥';

            if (text) {
                const item = {
                    id: id,
                    texto: text,
                    tipo: 'registrable', // Ahora todo es registrable por default para simplificar fase 2
                    tag: tag,
                    estado: 'pendiente'
                };

                obligationsMarkdown += `- [ ] ${emoji} ${text}\n`;
                obligationsList.push(item);
            }
        });

        const b1JSON = JSON.stringify(obligationsList);
        document.getElementById('b1').value = b1JSON;

        const b2 = document.getElementById('b2').value;
        const b3 = document.getElementById('b3').value;

        // Formato limpio para la bit√°cora
        const text = `**Obligaciones**
${obligationsMarkdown || '(Ninguna)'}

**Estructural**
${b2}

**Reactivo/Libre**
${b3}`;

        document.getElementById('daily-full-content').value = text;
        document.getElementById('daily-preview').innerText = text;
        document.getElementById('daily-preview-container').classList.remove('hidden');
    }

    // Load Previous Inventory Functionality

    function toggleSidebar() {
        const sidebar = document.getElementById('planning-sidebar');
        const showBtn = document.getElementById('show-context-helper');

        // Check current display style
        // Note: sidebar.style.display might be empty initially (meaning block from CSS)
        const isHidden = sidebar.style.display === 'none';

        if (isHidden) {
            sidebar.style.display = 'block';
            showBtn.style.display = 'none';
        } else {
            sidebar.style.display = 'none';
            showBtn.style.display = 'block';
        }
    }

</script>
{% endblock %}