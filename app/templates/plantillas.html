{% extends "base.html" %}

{% block content %}
<div style="margin-bottom: 3rem;">
    <h1>Plantillas de Pensamiento</h1>
    <p class="meta-text">Herramientas para descargar la mente y estructurar el d√≠a. Sin juicio, sin m√©tricas.</p>
</div>

<div class="form-section"
    style="background: linear-gradient(135deg, #fafaf8 0%, #f5f5f3 100%); border-left: 3px solid #9CA3AF; display: flex; align-items: center; justify-content: space-between; gap: 2rem;">
    <div>
        <h2>üìù Inventario Semanal</h2>
        <p style="font-style: italic; color: #666; margin-bottom: 0;">
            <strong>Objetivo:</strong> Vaciar la mente. No es una lista de tareas, es un registro de realidad.<br>
            <span style="font-size: 0.9rem;">(Frecuencia: Domingos o Lunes. Duraci√≥n: 15 min)</span>
        </p>
    </div>
    <div style="text-align: right;">
        <a href="/nuevo-inventario" class="btn" style="white-space: nowrap;">
            ‚ú® Iniciar Nuevo Inventario
        </a>
        <p style="font-size: 0.8rem; color: #6B7280; margin-top: 0.5rem; font-style: italic;">
            Te llevar√° a la nueva interfaz
        </p>
    </div>
</div>

<div class="form-section"
    style="background: linear-gradient(135deg, #ffffff 0%, #fefefe 100%); border-left: 3px solid #3B82F6;">
    <h2>‚ö° Plan Diario</h2>
    <p style="font-weight: 600; color: #1a1a1a; margin-bottom: 0.5rem; font-size: 1rem;">
        Aqu√≠ s√≠ se decide. Poco. Consciente.
    </p>
    <p style="font-style: italic; color: #666; margin-bottom: 2rem;">
        Principio: Sostener el d√≠a con dignidad. <strong>Tres bloques.</strong> No llenar por llenar.
    </p>

    <!-- Collapsible Last Inventory Context -->
    {% if inventario %}
    <details
        style="margin-bottom: 1.5rem; border: 1px solid #E5E7EB; border-radius: 8px; overflow: hidden; background: #F9FAFB;">
        <summary
            style="padding: 1rem 1.25rem; cursor: pointer; font-weight: 600; color: #374151; display: flex; align-items: center; gap: 0.75rem; user-select: none; transition: background-color 0.2s;">
            <span style="font-size: 1.1rem;">üìã</span>
            <span>Ver √öltimo Inventario Semanal</span>
            <span style="margin-left: auto; font-size: 0.8rem; font-weight: 400; color: #6B7280;">{{
                inventario.timestamp }}</span>
        </summary>

        <div style="padding: 1.5rem; background: white; border-top: 1px solid #E5E7EB;">
            <p style="font-size: 0.85rem; color: #6B7280; margin-bottom: 1.25rem; font-style: italic;">
                Este es tu contexto semanal. Recuerda: del inventario completo, solo UNA cosa puede convertirse en tarea
                estructural hoy.
            </p>

            {% if inventario.energia %}
            <div style="margin-bottom: 1.25rem;">
                <div
                    style="font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; color: #9CA3AF; margin-bottom: 0.5rem; font-weight: 600;">
                    Energ√≠a / Estado</div>
                <div
                    style="padding: 0.75rem; background: #FEF3C7; border-left: 3px solid #F59E0B; border-radius: 4px; font-size: 0.9rem; line-height: 1.6; color: #78350F; white-space: pre-wrap;">
                    {{ inventario.energia }}</div>
            </div>
            {% endif %}

            {% if inventario.claridad_frentes %}
            <div style="margin-bottom: 1.25rem;">
                <div
                    style="font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; color: #9CA3AF; margin-bottom: 0.5rem; font-weight: 600;">
                    Claridad de Frentes</div>
                <div
                    style="padding: 0.75rem; background: #EFF6FF; border-left: 3px solid #3B82F6; border-radius: 4px; font-size: 0.9rem; line-height: 1.6; color: #1E40AF; white-space: pre-wrap;">
                    {{ inventario.claridad_frentes }}</div>
            </div>
            {% endif %}

            {% if inventario.ajuste_necesario %}
            <div>
                <div
                    style="font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; color: #9CA3AF; margin-bottom: 0.5rem; font-weight: 600;">
                    Ajuste Necesario</div>
                <div
                    style="padding: 0.75rem; background: #F3F4F6; border-left: 3px solid #6B7280; border-radius: 4px; font-size: 0.9rem; line-height: 1.6; color: #374151; white-space: pre-wrap;">
                    {{ inventario.ajuste_necesario }}</div>
            </div>
            {% endif %}
        </div>
    </details>
    {% else %}
    <div
        style="margin-bottom: 1.5rem; padding: 1rem; background: #F9FAFB; border: 1px dashed #D1D5DB; border-radius: 6px; text-align: center; color: #6B7280; font-size: 0.9rem; font-style: italic;">
        No hay inventario semanal registrado. <a href="#inventario-semanal"
            style="color: #3B82F6; text-decoration: underline;">Crear uno primero</a> te ayudar√° a tener contexto para
        planificar.
    </div>
    {% endif %}

    <div
        style="background: #FEF3C7; padding: 1rem; border-radius: 4px; margin-bottom: 1.5rem; border-left: 3px solid #F59E0B;">
        <p style="margin: 0; font-size: 0.85rem; line-height: 1.6; color: #92400E;">
            <strong>‚ö†Ô∏è Recordatorio:</strong> Del inventario completo, solo UNA cosa puede ser tarea estructural hoy
            (Bloque 2). Los otros items siguen ah√≠, no desaparecen, no se convierten en culpa.
        </p>
    </div>

    <!-- Panel Realidad vs Intenci√≥n (Historial de Puntos) -->
    <!-- ESTO SE MOSTRAR√Å SOLO SI EL BACKEND ENV√çA DATOS (Fase 2) -->
    {% if state is defined and state.historial_puntos %}
    <div
        style="background: #ffffff; border: 1px solid #e5e7eb; border-radius: 8px; padding: 1rem; margin-bottom: 1.5rem; display: flex; align-items: center; justify-content: space-between;">
        <div style="font-size: 0.85rem; color: #4b5563; font-weight: 600;">
            üîç Realidad de los √∫ltimos d√≠as
        </div>
        <div style="display: flex; gap: 1.5rem;">
            {% for dia in state.historial_puntos %}
            <div style="display: flex; flex-direction: column; align-items: center; gap: 0.25rem;">
                <span style="font-size: 0.7rem; color: #9ca3af; text-transform: uppercase;">{{ dia.fecha[-5:] }}</span>
                <div style="display: flex; gap: 2px;">
                    {% for punto in dia.puntos %}
                    <div style="width: 8px; height: 8px; border-radius: 50%; background-color: {% if punto == 'red' %}#ef4444{% elif punto == 'green' %}#10b981{% elif punto == 'blue' %}#3b82f6{% else %}#d1d5db{% endif %};"
                        title="{{ punto }}"></div>
                    {% endfor %}
                    {% if not dia.puntos %}
                    <span style="font-size: 0.7rem; color: #d1d5db;">(Sin datos)</span>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <form action="/api/guardar" method="POST" id="daily-form">
        <input type="hidden" name="tipo" value="Plan Diario">

        <div class="form-group">
            <label>1. Obligaciones Reales (Ya existen)</label>
            <div
                style="background: #eef2ff; border-left: 3px solid #6366f1; padding: 0.75rem; margin-bottom: 1rem; font-size: 0.85rem; color: #4338ca;">
                <strong>Micro-decisi√≥n:</strong> Etiqueta cada tarea. <br>
                <span style="color: #ef4444;">üî¥ Foco (Trabajo)</span> |
                <span style="color: #10b981;">üü¢ Mante (Sost√©n)</span> |
                <span style="color: #3b82f6;">üîµ Semilla (Futuro)</span>
            </div>

            <div id="obligaciones-container"
                style="display: flex; flex-direction: column; gap: 0.5rem; margin-bottom: 1rem;">
                <!-- Rows will be added here -->
            </div>

            <button type="button" class="btn btn-outline" onclick="addObligationRow()"
                style="font-size: 0.85rem; padding: 0.5rem 1rem;">
                + A√±adir obligaci√≥n
            </button>

            <input type="hidden" name="obligaciones" id="b1">
        </div>

        <div class="form-group"
            style="background: #F3F4F6; padding: 1.5rem; border-radius: 4px; border: 2px dashed #9CA3AF;">
            <label style="color: #EF4444;">2. Tarea Estructural (M√°ximo 1 ‚Äî SOLO UNA)</label>
            <small style="display: block; color: #666; margin-bottom: 0.5rem; font-style: italic;">
                Ej: "Tarea ancla: entender flujo Remedy".
            </small>
            <div style="display: flex; gap: 0.5rem;">
                <input type="text" name="tarea_ancla" id="b2" placeholder="Opcional. Solo si hay capacidad."
                    style="padding: 1.2rem; flex: 3;">

                <!-- Horizonte Esperado (Fase 2) -->
                <select name="horizonte_tarea_ancla" id="b2-horizonte"
                    style="flex: 1; padding: 0.5rem; font-size: 0.85rem; border: 1px solid #d1d5db; border-radius: 4px; color: #4b5563;">
                    <option value="">(Horizonte)</option>
                    <option value="1-2 d√≠as">1-2 d√≠as</option>
                    <option value="3-5 d√≠as">3-5 d√≠as</option>
                    <option value="1 semana">1 semana</option>
                    <option value="2 semanas">2 semanas</option>
                    <option value="+1 mes">+1 mes</option>
                </select>
            </div>
        </div>

        <div class="form-group">
            <label>3. Espacio Reactivo / Libre</label>
            <textarea name="resto_dia" id="b3" style="min-height: 100px;"
                placeholder="Responder mensajes, imprevistos, descanso..."></textarea>
        </div>

        <input type="hidden" name="contenido" id="daily-full-content">

        <div id="daily-preview-container" class="hidden">
            <label>Confirmar Plan</label>
            <div id="daily-preview" class="preview-box"></div>
        </div>

        <div style="display: flex; gap: 1rem; align-items: center;">
            <button type="button" class="btn btn-outline" onclick="composeDaily()">Ver Vista Previa</button>
            <button type="submit" class="btn" onclick="composeDaily()">Comprometer Plan</button>
        </div>
    </form>
</div>

<script>
    // Initialize with one empty row
    docReady(function () {
        if (document.getElementById('obligaciones-container')) {
            addObligationRow();
        }
    });

    function generateUUID() {
        return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
            var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
            return v.toString(16);
        });
    }

    function addObligationRow(text = '', type = 'foco') {
        const container = document.getElementById('obligaciones-container');
        const id = generateUUID();

        const row = document.createElement('div');
        row.className = 'obligation-row';
        row.dataset.id = id;
        row.style.display = 'flex';
        row.style.gap = '0.5rem';
        row.style.alignItems = 'center';
        row.style.padding = '0.5rem';
        row.style.background = 'white';
        row.style.border = '1px solid #e5e7eb';
        row.style.borderRadius = '6px';

        // Check registable vs nota? Mantenemos simple con selector de tag
        // Nuevo dise√±o: Input texto + Radio buttons de colores

        row.innerHTML = `
            <div style="flex: 1;">
                <input type="text" class="form-control obl-text" value="${text}" placeholder="Descripci√≥n..." 
                    style="width: 100%; border: none; outline: none; font-size: 0.95rem;">
            </div>
            
            <div style="display: flex; gap: 0.25rem; background: #f3f4f6; padding: 0.25rem; border-radius: 4px;">
                <label style="cursor: pointer; display: flex; align-items: center; padding: 0 0.25rem;" title="Foco (Trabajo)">
                    <input type="radio" name="tag_${id}" value="foco" checked class="obl-tag">
                    <span style="font-size: 0.8rem;">üî¥</span>
                </label>
                <label style="cursor: pointer; display: flex; align-items: center; padding: 0 0.25rem;" title="Mantenimiento">
                    <input type="radio" name="tag_${id}" value="mantenimiento" class="obl-tag">
                    <span style="font-size: 0.8rem;">üü¢</span>
                </label>
                <label style="cursor: pointer; display: flex; align-items: center; padding: 0 0.25rem;" title="Semilla (Futuro)">
                    <input type="radio" name="tag_${id}" value="semilla" class="obl-tag">
                    <span style="font-size: 0.8rem;">üîµ</span>
                </label>
            </div>

            <button type="button" class="btn btn-outline" onclick="removeObligationRow(this)" style="padding: 0.2rem 0.5rem; color: #9ca3af; border: none;" title="Eliminar">
                ‚úï
            </button>
        `;

        container.appendChild(row);

        // Focus new input if it's empty
        if (!text) {
            row.querySelector('input').focus();
        }
    }

    function removeObligationRow(btn) {
        btn.parentElement.remove();
    }

    function docReady(fn) {
        if (document.readyState === "complete" || document.readyState === "interactive") {
            setTimeout(fn, 1);
        } else {
            document.addEventListener("DOMContentLoaded", fn);
        }
    }

    function composeDaily() {
        // Collect Obligations
        const rows = document.querySelectorAll('.obligation-row');
        const obligationsList = [];
        let obligationsMarkdown = '';

        rows.forEach(row => {
            const text = row.querySelector('.obl-text').value.trim();
            // Get selected radio
            const selectedRadio = row.querySelector('input[type="radio"]:checked');
            const tag = selectedRadio ? selectedRadio.value : 'foco';

            const id = row.dataset.id;

            // Map tag to emoji for markdown
            const emojis = { 'foco': 'üî¥', 'mantenimiento': 'üü¢', 'semilla': 'üîµ' };
            const emoji = emojis[tag] || 'üî¥';

            if (text) {
                const item = {
                    id: id,
                    texto: text,
                    tipo: 'registrable', // Ahora todo es registrable por default para simplificar fase 2
                    tag: tag,
                    estado: 'pendiente'
                };

                obligationsMarkdown += `- [ ] ${emoji} ${text}\n`;
                obligationsList.push(item);
            }
        });

        const b1JSON = JSON.stringify(obligationsList);
        document.getElementById('b1').value = b1JSON;

        const b2 = document.getElementById('b2').value;
        const b3 = document.getElementById('b3').value;

        // Formato limpio para la bit√°cora
        const text = `**Obligaciones**
${obligationsMarkdown || '(Ninguna)'}

**Estructural**
${b2}

**Reactivo/Libre**
${b3}`;

        document.getElementById('daily-full-content').value = text;
        document.getElementById('daily-preview').innerText = text;
        document.getElementById('daily-preview-container').classList.remove('hidden');
    }

    // Load Previous Inventory Functionality

</script>
{% endblock %}