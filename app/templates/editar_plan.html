{% extends "base.html" %}

{% block content %}
<div style="margin-bottom: 2rem;">
    <h1>Ajustar Plan Diario de Hoy</h1>
    <p class="meta-text">
        Modifica tu plan seg√∫n lo que haya cambiado. Es normal ajustar, no es fracaso.
    </p>
</div>

<form action="/api/guardar-ajuste-plan" method="POST" id="form-ajuste-plan">

    {# ============================================================ #}
    {# SECCI√ìN: OBLIGACIONES REALES #}
    {# ============================================================ #}
    {# ============================================================ #}
    {# SECCI√ìN: OBLIGACIONES REALES #}
    {# ============================================================ #}
    <div class="form-group">
        <label>1. Obligaciones Reales (Ya existen)</label>
        <div
            style="background: #eef2ff; border-left: 3px solid #6366f1; padding: 0.75rem; margin-bottom: 1rem; font-size: 0.85rem; color: #4338ca;">
            <strong>Ajustando Realidad:</strong> ¬øCambi√≥ el tipo de tarea? <br>
            <span style="color: #ef4444;">üî¥ Foco (Trabajo)</span> |
            <span style="color: #10b981;">üü¢ Mante (Sost√©n)</span> |
            <span style="color: #3b82f6;">üîµ Semilla (Futuro)</span>
        </div>

        <div id="obligaciones-container"
            style="display: flex; flex-direction: column; gap: 0.75rem; margin-bottom: 1rem;">
            {# Las obligaciones se cargan aqu√≠ desde JavaScript o Jinja2 #}
            {% if obligaciones %}
            {% for obl in obligaciones %}
            <div class="obligation-row" data-id="{{ obl.id }}"
                style="display: flex; gap: 0.5rem; align-items: center; padding: 0.5rem; background: white; border: 1px solid #e5e7eb; border-radius: 6px;">

                <div style="flex: 1;">
                    <input type="text" class="obl-text" value="{{ obl.texto }}" placeholder="Descripci√≥n..."
                        style="width: 100%; border: none; outline: none; font-size: 0.95rem;">
                </div>

                <div style="display: flex; gap: 0.25rem; background: #f3f4f6; padding: 0.25rem; border-radius: 4px;">
                    <label style="cursor: pointer; display: flex; align-items: center; padding: 0 0.25rem;"
                        title="Foco (Trabajo)">
                        <input type="radio" name="tag_{{ obl.id }}" value="foco" {% if obl.tag=='foco' or not obl.tag
                            %}checked{% endif %} class="obl-tag">
                        <span style="font-size: 0.8rem;">üî¥</span>
                    </label>
                    <label style="cursor: pointer; display: flex; align-items: center; padding: 0 0.25rem;"
                        title="Mantenimiento">
                        <input type="radio" name="tag_{{ obl.id }}" value="mantenimiento" {% if obl.tag=='mantenimiento'
                            %}checked{% endif %} class="obl-tag">
                        <span style="font-size: 0.8rem;">üü¢</span>
                    </label>
                    <label style="cursor: pointer; display: flex; align-items: center; padding: 0 0.25rem;"
                        title="Semilla (Futuro)">
                        <input type="radio" name="tag_{{ obl.id }}" value="semilla" {% if obl.tag=='semilla' %}checked{%
                            endif %} class="obl-tag">
                        <span style="font-size: 0.8rem;">üîµ</span>
                    </label>
                </div>

                <button type="button" class="btn btn-outline" onclick="eliminarObligacion(this)"
                    style="padding: 0.2rem 0.5rem; color: #9ca3af; border: none;" title="Eliminar">
                    ‚úï
                </button>
            </div>
            {% endfor %}
            {% endif %}
        </div>

        <button type="button" class="btn btn-outline" onclick="anadirObligacion()"
            style="font-size: 0.85rem; padding: 0.5rem 1rem;">
            + A√±adir obligaci√≥n
        </button>

        {# Campo oculto que contendr√° el JSON de obligaciones #}
        <input type="hidden" name="obligaciones" id="obligaciones-json">
    </div>

    {# ============================================================ #}
    {# SECCI√ìN: TAREA ESTRUCTURAL #}
    {# ============================================================ #}
    <div class="form-group"
        style="background: #F3F4F6; padding: 1.5rem; border-radius: 4px; border: 2px dashed #9CA3AF;">
        <label style="color: #EF4444;">2. Tarea Estructural (M√°ximo 1 ‚Äî SOLO UNA)</label>
        <div style="display: flex; gap: 0.5rem;">
            <input type="text" name="tarea_ancla" id="tarea_ancla" value="{{ tarea_ancla }}"
                placeholder="Opcional. Solo si hay capacidad." style="padding: 1.2rem; flex: 3;">

            <!-- Horizonte Esperado (Fase 2) -->
            <select name="horizonte_tarea_ancla" id="horizonte_tarea_ancla"
                style="flex: 1; padding: 0.5rem; font-size: 0.85rem; border: 1px solid #d1d5db; border-radius: 4px; color: #4b5563;">
                <option value="">(Horizonte)</option>
                <option value="1-2 d√≠as">1-2 d√≠as</option>
                <option value="3-5 d√≠as">3-5 d√≠as</option>
                <option value="1 semana">1 semana</option>
                <option value="2 semanas">2 semanas</option>
                <option value="+1 mes">+1 mes</option>
            </select>
        </div>
    </div>

    {# ============================================================ #}
    {# SECCI√ìN: ESPACIO REACTIVO #}
    {# ============================================================ #}
    <div class="form-group">
        <label>3. Espacio Reactivo / Libre</label>
        <small style="display: block; color: #888; margin-bottom: 0.5rem; font-style: italic;">
            No se planifica. Acepta que existir√°.
        </small>
        <textarea name="resto_dia" id="resto_dia" style="min-height: 100px;"
            placeholder="Responder mensajes, imprevistos, descanso...">{{ resto_dia }}</textarea>
    </div>

    {# ============================================================ #}
    {# SECCI√ìN: CONTEXTO DEL AJUSTE #}
    {# ============================================================ #}
    <div class="form-group"
        style="background: #FEF3C7; padding: 1.5rem; border-radius: 4px; border-left: 4px solid #F59E0B;">
        <label style="color: #92400E; font-weight: 600;">‚ö†Ô∏è ¬øPor qu√© est√°s ajustando el plan?</label>
        <small style="display: block; color: #92400E; margin-bottom: 0.5rem; font-style: italic;">
            S√© espec√≠fico y reflexivo (m√≠nimo 20 caracteres, m√°ximo 300)
        </small>
        <textarea name="por_que" id="por_que" required minlength="20" maxlength="300"
            style="min-height: 100px; border: 2px solid #F59E0B;"
            placeholder="Ej: Surgi√≥ una tarea urgente del cliente que requiere atenci√≥n inmediata. Decid√≠ eliminar la tarea ancla para mantener estabilidad."></textarea>
        <small id="char-counter" style="display: block; margin-top: 0.5rem; color: #92400E; font-size: 0.85rem;">
            0 / 300 caracteres
        </small>
    </div>

    {# ============================================================ #}
    {# BOTONES DE ACCI√ìN #}
    {# ============================================================ #}
    <div style="display: flex; gap: 1rem; align-items: center; margin-top: 2rem;">
        <a href="/" class="btn btn-outline">Cancelar</a>
        <button type="submit" class="btn" id="btn-guardar">Guardar Ajuste</button>
    </div>
</form>

{# ============================================================ #}
{# JAVASCRIPT - Separado completamente de Jinja2 #}
{# ============================================================ #}
<script>
    // ============================================================================
    // Inicializaci√≥n
    // ============================================================================
    document.addEventListener('DOMContentLoaded', function () {
        // Contador de caracteres para "Por qu√©"
        const porQueTextarea = document.getElementById('por_que');
        const charCounter = document.getElementById('char-counter');

        porQueTextarea.addEventListener('input', function () {
            const length = this.value.length;
            charCounter.textContent = `${length} / 300 caracteres`;

            if (length < 20) {
                charCounter.style.color = '#EF4444';
            } else {
                charCounter.style.color = '#10B981';
            }
        });

        // Al enviar el formulario, serializar obligaciones a JSON
        document.getElementById('form-ajuste-plan').addEventListener('submit', function (e) {
            serializarObligaciones();
        });
    });

    // ============================================================================
    // Funciones para gestionar obligaciones
    // ============================================================================

    function anadirObligacion() {
        const container = document.getElementById('obligaciones-container');
        const id = generarUUID();

        const row = document.createElement('div');
        row.className = 'obligation-row';
        row.setAttribute('data-id', id);
        row.style.display = 'flex';
        row.style.gap = '0.5rem';
        row.style.alignItems = 'center';
        row.style.padding = '0.5rem';
        row.style.background = 'white';
        row.style.border = '1px solid #e5e7eb';
        row.style.borderRadius = '6px';

        row.innerHTML = `
        <div style="flex: 1;">
            <input type="text" class="obl-text" placeholder="Descripci√≥n..." 
                style="width: 100%; border: none; outline: none; font-size: 0.95rem;">
        </div>
        
        <div style="display: flex; gap: 0.25rem; background: #f3f4f6; padding: 0.25rem; border-radius: 4px;">
            <label style="cursor: pointer; display: flex; align-items: center; padding: 0 0.25rem;" title="Foco (Trabajo)">
                <input type="radio" name="tag_${id}" value="foco" checked class="obl-tag">
                <span style="font-size: 0.8rem;">üî¥</span>
            </label>
            <label style="cursor: pointer; display: flex; align-items: center; padding: 0 0.25rem;" title="Mantenimiento">
                <input type="radio" name="tag_${id}" value="mantenimiento" class="obl-tag">
                <span style="font-size: 0.8rem;">üü¢</span>
            </label>
            <label style="cursor: pointer; display: flex; align-items: center; padding: 0 0.25rem;" title="Semilla (Futuro)">
                <input type="radio" name="tag_${id}" value="semilla" class="obl-tag">
                <span style="font-size: 0.8rem;">üîµ</span>
            </label>
        </div>

        <button type="button" class="btn btn-outline" onclick="eliminarObligacion(this)" 
                style="padding: 0.2rem 0.5rem; color: #9ca3af; border: none;" title="Eliminar">
            ‚úï
        </button>
    `;

        container.appendChild(row);

        // Enfocar el nuevo input
        row.querySelector('.obl-text').focus();
    }

    function eliminarObligacion(btn) {
        btn.closest('.obligation-row').remove();
    }

    function serializarObligaciones() {
        const rows = document.querySelectorAll('.obligation-row');
        const obligaciones = [];

        rows.forEach(row => {
            const texto = row.querySelector('.obl-text').value.trim();
            // Get selected radio
            const selectedRadio = row.querySelector('input[type="radio"]:checked');
            const tag = selectedRadio ? selectedRadio.value : 'foco';

            const id = row.getAttribute('data-id');

            if (texto) {
                obligaciones.push({
                    id: id,
                    texto: texto,
                    tipo: 'registrable',
                    tag: tag,
                    estado: 'pendiente'
                });
            }
        });

        document.getElementById('obligaciones-json').value = JSON.stringify(obligaciones);
    }

    function generarUUID() {
        return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
            var r = Math.random() * 16 | 0;
            var v = c == 'x' ? r : (r & 0x3 | 0x8);
            return v.toString(16);
        });
    }
</script>

<style>
    .obligation-row {
        transition: background-color 0.2s;
    }

    .obligation-row:hover {
        background-color: #f9fafb;
    }
</style>

{% endblock %}